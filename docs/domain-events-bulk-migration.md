# Bulk Migration to Entity-Based Event Collection

This document provides step-by-step instructions for implementing the standardized entity-based domain event collection pattern across all repositories using the automated scripts.

## Overview

We've created a set of tools to make it easier to migrate repositories from direct event publishing to entity-based event collection:

1. **Enhanced BaseRepository**: Added helper methods to standardize the implementation
2. **Repository Update Script**: Automatically updates repositories to use the new pattern
3. **Checklist Update Script**: Keeps the migration checklist up to date

## Prerequisites

Before running the migration scripts, ensure:

1. Your domain entities extend the base `Entity` class
2. The `BaseRepository` has been updated with the event collection helpers
3. You have Node.js installed to run the scripts

## Migration Process

### Step 1: Update the BaseRepository

The `BaseRepository` class has been enhanced with these helper methods:

- `_saveWithEvents`: Standardized method for saving entities with event collection
- `_deleteWithEvents`: Standardized method for deleting entities with event collection
- `_batchWithEvents`: Standardized method for batch operations with event collection

These helper methods centralize the implementation of entity-based event collection, making it easier to apply consistently across repositories.

### Step 2: Run the Repository Update Script

The repository update script automatically transforms repositories to use the new pattern:

```bash
# First, do a dry run to see what would be changed
node scripts/update-repositories.js --dry-run --verbose

# When ready, run the actual update
node scripts/update-repositories.js
```

Options:
- `--dry-run`: Shows what would be changed without actually modifying files
- `--verbose`: Shows detailed logs about the transformation process
- `--path=src/core/domain`: Specify a specific path to scan (default: src/core)

The script will:
1. Scan for repository files in the codebase
2. Identify direct event publishing patterns
3. Replace them with standardized code that:
   - Collects events from entities before operations
   - Uses transactions for all database operations
   - Returns events to be published after commit
   - Clears events from entities after collection
4. Generate a report in the `reports` directory

### Step 3: Update the Repository Checklist

After running the update script, update the migration checklist:

```bash
# Update the checklist with the latest report
node scripts/update-repository-checklist.js reports/repository-update-123456789.json
```

This will update the `docs/repository-update-checklist.md` file with the current status of each repository.

### Step 4: Test the Updated Repositories

After the automated update, it's crucial to test each repository:

```bash
# Run tests for a specific domain
npm test -- --grep "UserRepository"
```

## What the Scripts Do

### The Repository Update Script

The update script looks for common patterns in repositories:

1. Direct `eventBus.publish()` calls
2. Methods using `_withRetry()` instead of `withTransaction()`
3. Event publishing after database operations

It replaces these patterns with standardized code that:

1. Collects events from entities before operations
2. Uses transactions for all database operations
3. Returns events to be published after commit
4. Clears events from entities after collection

### The Checklist Update Script

This script keeps the migration checklist up to date by:

1. Reading the report generated by the update script
2. Finding and updating the corresponding repository entries in the checklist
3. Updating the status indicators (✅ or ⬜️)
4. Adding a summary of the update at the end of the file

## Manual Cleanup

After running the automated scripts, you might need to manually clean up some repositories:

1. **Complex Logic**: Repositories with complex logic might need manual adjustment
2. **Custom Event Structure**: Repositories with non-standard event formats
3. **Tests**: Update tests to check for entity-based event collection

## Verification Steps

For each updated repository, verify:

1. Domain events are collected from entities
2. No direct event publishing occurs
3. Events are published only after successful transactions
4. All database operations occur within transactions
5. Tests pass with the new implementation

## Troubleshooting

Common issues and solutions:

### Events Not Being Published

If events aren't being published after a successful operation:
- Check that `publishEvents: true` is set in the transaction options
- Verify that the entity has the proper domain events added
- Ensure the entity extends the base `Entity` class

### Database Operations Failing

If database operations are failing after the update:
- Ensure transactions are being used correctly
- Check that the database client is being passed correctly

### Error with Event Structure

If there are errors with the event structure:
- Verify that the entity's `addDomainEvent` method is being used correctly
- Check that the event type is properly defined

## Rollback Plan

If you encounter serious issues:

1. Revert the repository file to its original state
2. Temporarily reintroduce direct event publishing
3. Plan for a more careful manual migration 