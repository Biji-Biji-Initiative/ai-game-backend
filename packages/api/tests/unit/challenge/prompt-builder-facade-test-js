import { expect } from "../../../tests/test-helpers/setup.js";
import { jest } from '@jest/globals';
import { createTestUser, createTestChallenge } from "../../helpers/testFactory.js";
import promptBuilder from "../../../src/core/prompt/promptBuilder.js";
import promptTypes from "../../../src/core/prompt/promptTypes.js";
import { ChallengeError, ChallengeNotFoundError, ChallengeValidationError, ChallengeProcessingError, ChallengeRepositoryError, ChallengeGenerationError } from "../../../src/core/challenge/errors/ChallengeErrors.js";
const { PROMPT_TYPES } = promptTypes;
describe('Prompt Builder Domain', function () {
    beforeEach(function () {
        // Initialize mocks
        jest.clearAllMocks();
    });
    describe('Focus Area Prompt Building', function () {
        it('should build a focus area prompt with user data', async function () {
            // Create test user data
            const user = createTestUser({
                personality_traits: ['curious', 'analytical', 'thoughtful'],
                ai_attitudes: ['optimistic', 'pragmatic'],
                professionalTitle: 'Software Engineer',
                location: 'San Francisco'
            });
            // Mock the buildPrompt function to avoid external dependencies
            promptBuilder.buildPrompt = jest.fn().mockResolvedValue(
                "Generate 3 focus areas for a Software Engineer from San Francisco " +
                "who is curious, analytical, and thoughtful with optimistic, pragmatic " +
                "attitudes toward AI."
            );
            // Build a focus area prompt
            const prompt = await promptBuilder.buildPrompt(PROMPT_TYPES.FOCUS_AREA, {
                user,
                options: {
                    count: 3,
                    creativeVariation: 0.7
                }
            });
            // Verify the prompt was created and contains relevant information
            expect(prompt).to.be.a('string');
            expect(prompt.length).to.be.greaterThan(100);
            // Check for user data in the prompt
            expect(prompt).to.include('Software Engineer');
            expect(prompt).to.include('San Francisco');
            // Should mention at least one trait
            const hasTraitMentioned = user.personality_traits.some(trait => prompt.toLowerCase().includes(trait.toLowerCase()));
            expect(hasTraitMentioned).to.be.true;
        });
    });
    describe('Personality Insights Prompt Building', function () {
        it('should build a personality insights prompt with interaction history', async function () {
            // Create test data
            const user = createTestUser();
            const interactionHistory = [
                {
                    type: 'challenge',
                    content: 'User completed a challenge about effective questioning.',
                    timestamp: new Date(Date.now() - 86400000) // 1 day ago
                },
                {
                    type: 'feedback',
                    content: 'User demonstrated strong analytical skills but could improve clarity.',
                    timestamp: new Date(Date.now() - 43200000) // 12 hours ago
                }
            ];
            // Mock the buildPrompt function
            promptBuilder.buildPrompt = jest.fn().mockResolvedValue(
                "Generate personality insights based on the user's history " +
                "including challenges about effective questioning and feedback " +
                "showing strong analytical skills but needing clarity improvements."
            );
            // Build a personality insights prompt
            const prompt = await promptBuilder.buildPrompt(PROMPT_TYPES.PERSONALITY, {
                user,
                interactionHistory,
                options: {
                    detailLevel: 'high',
                    focusAreas: ['communication', 'analytical-thinking']
                }
            });
            // Verify the prompt was created
            expect(prompt).to.be.a('string');
            expect(prompt.length).to.be.greaterThan(100);
            // Should include context about the history
            expect(prompt.toLowerCase()).to.include('history');
            expect(prompt.toLowerCase()).to.include('challenge');
            expect(prompt.toLowerCase()).to.include('analytical');
        });
    });
    describe('Error Handling', function () {
        it('should throw an error when using a non-existent prompt type', async function () {
            // Restore original implementation for this test
            promptBuilder.buildPrompt = jest.fn().mockRejectedValue(
                new Error("Unknown prompt type: non-existent-type")
            );
            try {
                await promptBuilder.buildPrompt('non-existent-type', {});
                // Should not reach here
                expect.fail('Should have thrown an error for non-existent prompt type');
            }
            catch (ChallengeError) {
                expect(ChallengeError.message).to.include('non-existent-type');
            }
        });
        it('should throw an error when missing required parameters', async function () {
            // Mock implementation for this test
            promptBuilder.buildPrompt = jest.fn().mockRejectedValue(
                new Error("Prompt validation failed: Missing required parameter 'user'")
            );
            try {
                // Missing user parameter
                await promptBuilder.buildPrompt(PROMPT_TYPES.FOCUS_AREA, {
                    options: { count: 3 }
                });
                // Should not reach here
                expect.fail('Should have thrown an error for missing parameters');
            }
            catch (ChallengeError) {
                expect(ChallengeError.message).to.include('validation');
            }
        });
    });
    describe('Prompt Builder Registration', function () {
        it('should allow registering and using a custom prompt builder', async function () {
            // Original implementation
            const originalRegisterBuilder = promptBuilder.registerBuilder;
            const originalBuildPrompt = promptBuilder.buildPrompt;
            
            // Mock functions for this test
            promptBuilder.registerBuilder = jest.fn();
            promptBuilder.buildPrompt = jest.fn().mockResolvedValue('This is a custom prompt for Test User');
            
            // Define a simple custom prompt builder
            const customBuilder = {
                type: 'custom-type',
                build: params => Promise.resolve(`This is a custom prompt for ${params.name}`)
            };
            
            // Register the custom builder
            promptBuilder.registerBuilder(customBuilder);
            
            // Use the custom builder
            const prompt = await promptBuilder.buildPrompt('custom-type', { name: 'Test User' });
            
            // Verify the custom builder was used
            expect(prompt).to.equal('This is a custom prompt for Test User');
            
            // Restore original implementations
            promptBuilder.registerBuilder = originalRegisterBuilder;
            promptBuilder.buildPrompt = originalBuildPrompt;
        });
    });
});
